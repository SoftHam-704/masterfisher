<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Upload - Inline Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f0f0f0;
        }

        .success {
            background: #d4edda !important;
            color: #155724;
        }

        .error {
            background: #f8d7da !important;
            color: #721c24;
        }

        .info {
            background: #d1ecf1 !important;
            color: #0c5460;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üñºÔ∏è Teste de Upload de Avatar</h1>
        <p>Este teste ir√° carregar a imagem <code>user_avatar.png</code> e fazer o upload para o perfil.</p>

        <button id="uploadBtn" onclick="uploadAvatar()">Iniciar Upload</button>
        <!DOCTYPE html>
        <html lang="pt-BR">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Avatar Upload - Inline Test</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 600px;
                    margin: 50px auto;
                    padding: 20px;
                    background: #f5f5f5;
                }

                .container {
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }

                h1 {
                    color: #333;
                    margin-bottom: 20px;
                }

                #status {
                    margin-top: 20px;
                    padding: 15px;
                    border-radius: 5px;
                    background: #f0f0f0;
                }

                .success {
                    background: #d4edda !important;
                    color: #155724;
                }

                .error {
                    background: #f8d7da !important;
                    color: #721c24;
                }

                .info {
                    background: #d1ecf1 !important;
                    color: #0c5460;
                }

                button {
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-top: 20px;
                }

                button:hover {
                    background: #0056b3;
                }

                button:disabled {
                    background: #6c757d;
                    cursor: not-allowed;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <h1>üñºÔ∏è Teste de Upload de Avatar</h1>
                <p>Este teste ir√° carregar a imagem <code>user_avatar.png</code> e fazer o upload para o perfil.</p>

                <button id="uploadBtn" onclick="uploadAvatar()">Iniciar Upload</button>

                <div id="status" class="info">
                    <p>‚è≥ Aguardando in√≠cio do teste...</p>
                </div>
            </div>

            <script>
                async function uploadAvatar() {
                    const statusDiv = document.getElementById('status');
                    const uploadBtn = document.getElementById('uploadBtn');
                    uploadBtn.disabled = true;

                    try {
                        statusDiv.className = 'info';
                        statusDiv.innerHTML = '<p>üîç Carregando imagem user_avatar.png...</p>';

                        // Fetch the user avatar image
                        const response = await fetch('/user_avatar.png');
                        if (!response.ok) {
                            throw new Error(`Falha ao carregar imagem: ${response.status} ${response.statusText}`);
                        }

                        const blob = await response.blob();
                        statusDiv.innerHTML += `<p>‚úÖ Imagem carregada: ${(blob.size / 1024).toFixed(2)} KB</p>`;
                        statusDiv.innerHTML += '<p>üîÑ Convertendo para base64...</p>';

                        // Convert to base64
                        const base64String = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });

                        statusDiv.innerHTML += `<p>‚úÖ Convers√£o completa: ${(base64String.length / 1024).toFixed(2)} KB</p>`;
                        statusDiv.innerHTML += '<p>üì§ Fazendo upload...</p>';
                        statusDiv.innerHTML += '<p><em>Nota: Este teste usa fetch direto para o Supabase REST API</em></p>';

                        // Get session token from localStorage (Supabase stores it there)
                        const supabaseSession = localStorage.getItem('sb-tbiutzyaxkqhqkxdciuf-auth-token');
                        if (!supabaseSession) {
                            throw new Error('Sess√£o n√£o encontrada. Por favor, fa√ßa login primeiro.');
                        }

                        const session = JSON.parse(supabaseSession);
                        const accessToken = session.access_token;
                        const userId = session.user.id;

                        statusDiv.innerHTML += `<p>‚úÖ Usu√°rio: ${session.user.email}</p>`;

                        // Update profile using Supabase REST API
                        const updateResponse = await fetch(
                            `https://tbiutzyaxkqhqkxdciuf.supabase.co/rest/v1/profiles?id=eq.${userId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4ZmJ0enhja2FzamFwcHZkaWtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE0NzAsImV4cCI6MjA3OTAzNzQ3MH0.TIgWhKm6S5OSIcxFMWYCX64nYjNPx3fz3LDZD5RKmS8',
                                    'Authorization': `Bearer ${accessToken}`,
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify({
                                    avatar_url: base64String
                                })
                            }
                        );

                        if (!updateResponse.ok) {
                            const errorText = await updateResponse.text();
                            throw new Error(`Erro ao atualizar perfil: ${updateResponse.status} - ${errorText}`);
                        }

                        const result = await updateResponse.json();

                        statusDiv.className = 'success';
                        statusDiv.innerHTML = '<p style="font-weight: bold; font-size: 18px;">‚úÖ Avatar atualizado com sucesso!</p>';
                        statusDiv.innerHTML += `<p>Dados atualizados: ${JSON.stringify(result, null, 2)}</p>`;
                        statusDiv.innerHTML += '<p>üîÑ Redirecionando para o perfil em 3 segundos...</p>';

                        setTimeout(() => {
                            window.location.href = 'http://localhost:8080/perfil';
                        }, 3000);

                    } catch (error) {
                        statusDiv.className = 'error';
                        statusDiv.innerHTML = `<p style="font-weight: bold;">‚ùå Erro:</p>`;
                        statusDiv.innerHTML += `<p>${error.message}</p>`;
                        statusDiv.innerHTML += `<p><small>${error.stack}</small></p>`;
                        uploadBtn.disabled = false;
                        console.error('Error in uploadAvatar:', error);
                    }
                }

                // Auto-execute on page load
                window.addEventListener('DOMContentLoaded', () => {
                    console.log('Page loaded, starting auto-upload...');
                    uploadAvatar();
                });
            </script>
        </body>

        </html>
